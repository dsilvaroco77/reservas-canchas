<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>TEST - Fichas de Jugador</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <meta name="theme-color" content="#001f33"/>
    <style>
        :root{--background-color:#001f33;--text-color:#f5f5f7;--subtle-text-color:#a1a1a6;--accent-color:#c6d300;--card-background:rgba(255,255,255,0.05);}
        @keyframes fadeIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;padding:0;background:var(--background-color);color:var(--text-color)}
        .main-container{max-width:900px;margin:0 auto;padding:40px 20px;animation:fadeIn 1s ease-out forwards}
        .header-section{text-align:center;margin-bottom:20px}
        .uct-logo{width:clamp(96px,14vw,168px);height:auto;display:block;margin:0 auto 12px;filter:drop-shadow(0 2px 6px rgba(0,0,0,.35))}
        h1{font-size:36px;font-weight:700;letter-spacing:-1px;margin:0}
        .ranking-info{text-align:center;margin-bottom:20px}
        .last-updated-date{font-size:14px;color:var(--subtle-text-color);font-style:italic}
        .section{background:var(--card-background);border-radius:18px;padding:18px 16px;margin-bottom:24px;}
        .section-header{display:flex;justify-content:space-between;align-items:center;margin:6px 6px 12px;}
        .section-header h2{font-size:22px;margin:0;color:var(--text-color);}
        table{width:100%;border-collapse:collapse;color:var(--text-color);display:none}
        th,td{padding:12px 15px;text-align:left;border-bottom:1px solid rgba(255,255,255,.1)}
        th{font-weight:600; color:var(--text-color);}
        tbody tr { cursor: pointer; transition: background-color 0.2s ease; }
        tbody tr:hover { background-color: rgba(255,255,255,0.03); }
        tr:last-child td{border-bottom:none}
        .loading{color:var(--subtle-text-color);font-style:italic;text-align:center;padding:10px}
        .footer-nav{text-align:center;margin-top:28px}
        .back-button{display:inline-block;background:var(--accent-color);color:#001f33;font-size:16px;font-weight:700;padding:12px 30px;border:none;border-radius:30px;cursor:pointer;text-decoration:none;transition:background-color .2s ease,transform .15s ease}
        .save-button{background-color:var(--accent-color);color:var(--background-color);border:none;padding:8px 16px;font-size:14px;font-weight:700;border-radius:20px;cursor:pointer;display:none;transition:all .2s ease;}
        .sortable-ghost{background:rgba(255,255,255,0.1);opacity:0.8;}
        .arrow-up{color:#4CAF50;} .arrow-down{color:#F44336;} .new-entry{color:#FFC107;}
        .col-pos {width:80px;text-align:center;} .col-evol {width:60px;text-align:center;font-size:1.2em;}
        td.col-nombre { font-weight: 600; }
        .player-highlight {
            background-image: linear-gradient(to right, rgba(200, 211, 0, 0.1), transparent 80%);
            border-left: 4px solid var(--accent-color);
        }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: all 0.3s ease; z-index: 1000; padding: 15px;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: #002a42; border: 1px solid rgba(255,255,255,.1); border-radius: 18px;
            width: 100%; max-width: 380px; padding: 25px; text-align: center;
            transform: scale(0.9); transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-photo {
            width: 120px; height: 120px; border-radius: 50%; object-fit: cover;
            border: 4px solid var(--accent-color); margin-bottom: 15px; background-color: #001f33;
        }
        .modal-name { font-size: 1.8em; font-weight: bold; margin-bottom: 5px; }
        .modal-category {
            display: inline-block; background: var(--accent-color); color: var(--background-color);
            font-size: 0.8em; font-weight: bold; padding: 4px 10px; border-radius: 15px;
            margin-bottom: 20px; text-transform: uppercase;
        }
        .modal-stats { list-style: none; padding: 0; text-align: left; }
        .modal-stats li {
            display: flex; justify-content: space-between; padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,.1); font-size: 1em;
        }
        .modal-stats li:last-child { border-bottom: none; }
        .modal-stats .label { color: var(--subtle-text-color); }
        .modal-stats .value { font-weight: bold; color: var(--text-color); }

        @media (max-width:768px){
            h1{font-size:28px}
            .section h2{font-size:20px}
            table thead { display: none; }
            table, tbody, tr, td { display: block; }
            tr {
                display: flex; align-items: center; padding: 10px 5px;
                border-bottom: 1px solid rgba(255,255,255,.1); margin-bottom: 5px;
            }
            .player-highlight { border-left-width: 5px; }
            td { border: none; padding: 2px 5px; }
            .col-pos { font-size: 1.1em; font-weight: bold; width: 45px; text-align: center; }
            .col-nombre { flex-grow: 1; width: auto; }
            .col-evol { width: 45px; text-align: center; font-size: 1.4em; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header-section">
            <img src="logo_uctenis_v03.png" alt="Logo UCTenis Club" class="uct-logo" loading="lazy"/>
            <h1>TEST DE FICHAS</h1>
        </div>
        <div class="ranking-info">
            <p class="last-updated-date" id="lastUpdatedDate">Cargando...</p>
        </div>

        <section class="section" id="secM">
            <div class="section-header">
                <h2>Ranking Femenino</h2>
                <button id="saveM" class="save-button" onclick="saveRanking('mujeres')">Guardar Cambios</button>
            </div>
            <div class="loading" id="loadingM">Cargando ranking...</div>
            <table id="tableM">
                <thead><tr><th class="col-pos">Pos.</th><th>Nombre</th><th class="col-evol">Evol.</th></tr></thead>
                <tbody id="tbodyM"></tbody>
            </table>
        </section>

        <section class="section" id="secH">
            <div class="section-header">
                <h2>Ranking Masculino</h2>
                <button id="saveH" class="save-button" onclick="saveRanking('hombres')">Guardar Cambios</button>
            </div>
            <div class="loading" id="loadingH">Cargando ranking...</div>
            <table id="tableH">
                <thead><tr><th class="col-pos">Pos.</th><th>Nombre</th><th class="col-evol">Evol.</th></tr></thead>
                <tbody id="tbodyH"></tbody>
            </table>
        </section>

        <div class="footer-nav">
            <a class="back-button" href="index.html">Volver a Reservar</a>
        </div>
    </div>

    <div class="modal-overlay" id="playerModal">
        <div class="modal-content"></div>
    </div>

    <script>
        // URL del script conectado a "test ranking"
        const API_URL = "https://script.google.com/macros/s/AKfycbxCpCp0gy4fEENaItRbt8qX3B0zt3EsbKifX_MWSu3gC2UqMDjf1uQku9bk9qYkNBLtuw/exec";

        let allPlayersData = []; 

        async function cargarDatos() {
            document.getElementById('lastUpdatedDate').textContent = 'Ranking al día: ' + new Date().toLocaleDateString('es-CL', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('loadingM').textContent = "Cargando...";
            document.getElementById('loadingH').textContent = "Cargando...";
            try {
                const response = await fetch(API_URL + '?v=' + Date.now());
                const data = await response.json();
                allPlayersData = [...(data.mujeres || []), ...(data.hombres || [])];
                renderTabla('tbodyM', 'tableM', 'loadingM', data.mujeres || []);
                renderTabla('tbodyH', 'tableH', 'loadingH', data.hombres || []);
                initSortable();
            } catch (err) {
                console.error('Fallo cargando ranking:', err);
                document.getElementById('loadingM').textContent = `Error: ${err.message}`;
                document.getElementById('loadingH').textContent = `Error: ${err.message}`;
            }
        }

        function renderTabla(tbodyId, tableId, loadingId, lista) {
            const tbody = document.getElementById(tbodyId);
            tbody.innerHTML = '';
            if (lista.length === 0) {
                document.getElementById(loadingId).textContent = 'No hay datos en esta sección.';
                return;
            }
            lista.forEach(p => {
                const tr = tbody.insertRow();
                tr.dataset.nombre = p.nombre;
                tr.addEventListener('click', () => showPlayerProfile(p.nombre));
                const isRanked = !isNaN(parseInt(p.posicion));
                tr.className = isRanked ? 'ranked-player' : 'unranked-player';
                const posActual = parseInt(p.posicion);
                const posAnterior = parseInt(p.posicionAnterior);
                let evolucionHtml = '';
                if (isRanked && !isNaN(posAnterior) && posAnterior > 0) {
                    if (posActual < posAnterior) evolucionHtml = `<span class="arrow-up" title="Subió desde ${posAnterior}">▲</span>`;
                    else if (posActual > posAnterior) evolucionHtml = `<span class="arrow-down" title="Bajó desde ${posAnterior}">▼</span>`;
                    else evolucionHtml = `<span class="new-entry" title="Mantuvo la posición">●</span>`;
                } else {
                    evolucionHtml = `<span class="new-entry" title="Nuevo en el ranking">●</span>`;
                }
                if (isRanked && !isNaN(posAnterior) && posAnterior > 0 && posActual !== posAnterior) {
                    tr.classList.add('player-highlight');
                }
                tr.innerHTML = `<td class="col-pos">${p.posicion}</td><td class="col-nombre">${p.nombre}</td><td class="col-evol">${evolucionHtml}</td>`;
            });
            document.getElementById(loadingId).style.display = 'none';
            document.getElementById(tableId).style.display = 'table';
        }

        function showPlayerProfile(playerName) {
            const playerData = allPlayersData.find(p => p.nombre === playerName);
            if (!playerData) return;
            const modalOverlay = document.getElementById('playerModal');
            const modalContent = modalOverlay.querySelector('.modal-content');
            modalContent.innerHTML = `
                <img src="${playerData.foto || 'default_avatar.png'}" class="modal-photo" alt="Foto de ${playerData.nombre}" onerror="this.src='default_avatar.png';">
                <h2 class="modal-name">${playerData.nombre}</h2>
                ${playerData.categoria ? `<div class="modal-category">${playerData.categoria}</div>` : ''}
                <ul class="modal-stats">
                    <li><span class="label">Ranking</span> <span class="value">${playerData.posicion}</span></li>
                    ${playerData.edad ? `<li><span class="label">Edad</span> <span class="value">${playerData.edad}</span></li>` : ''}
                    ${playerData.manoHabil ? `<li><span class="label">Mano Hábil</span> <span class="value">${playerData.manoHabil}</span></li>` : ''}
                    ${playerData.reves ? `<li><span class="label">Revés</span> <span class="value">${playerData.reves}</span></li>` : ''}
                </ul>
            `;
            modalOverlay.classList.add('visible');
        }

        document.getElementById('playerModal').addEventListener('click', function(e) {
            if (e.target === this) this.classList.remove('visible');
        });

        function initSortable() {
            // Esta función está aquí para que la página de test no dé error, pero no guardará cambios
            // en la hoja de "test ranking" a menos que la adaptemos.
        }

        function saveRanking(category) {
            alert("La función de guardar está deshabilitada en la página de pruebas.");
        }
        document.addEventListener('DOMContentLoaded', cargarDatos);
    </script>
</body>
</html>
